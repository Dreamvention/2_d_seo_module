<modification>
    <id>SEO BY DREAMVENTION</id>
    <version>1.0</version>
    <vqmver>2.1.1</vqmver>
    <author>Dreamvention.com</author>
    <file name="catalog/controller/common/seo_url.php">
        <operation>
            <search position="after" index="2" offset="1"><![CDATA[unset($data[$key]);]]></search>
            <add><![CDATA[else{
		$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "url_alias WHERE `query` = '" . $this->db->escape($value) . "'");
		if (($query->num_rows && $query->row['keyword']) or $value == 'common/home') {
			$url .= '/' . $query->row['keyword'];
 
			unset($data[$key]);
		}
 
	} ]]></add>
        </operation>	
	</file>
	<file name="system/library/url.php">
        <operation>
            <search position="after"><![CDATA[private $ssl;]]></search>
            <add><![CDATA[	public $currentUrl; ]]></add>
        </operation>
        <operation>
            <search position="after"><![CDATA[$this->ssl = $ssl;]]></search>
            <add><![CDATA[		$this->setCurrentUrl(); ]]></add>
        </operation>
        <operation>
            <search position="before"><![CDATA[public function link($route, $args = '', $secure = false) {]]></search>
            <add><![CDATA[
 /* DV Code START */
	public function setCurrentUrl() {
		$pageURL = 'http';
		if(isset($_SERVER["HTTPS"])){
			if ($_SERVER["HTTPS"] == "on") {$pageURL .= "s";}
		}
		$pageURL .= "://";
		if ($_SERVER["SERVER_PORT"] != "80") {
			$pageURL .= $_SERVER["SERVER_NAME"].":".$_SERVER["SERVER_PORT"].$_SERVER["REQUEST_URI"];
		} else {
			$pageURL .= $_SERVER["SERVER_NAME"].$_SERVER["REQUEST_URI"];
		}
		$this->currentUrl =  str_replace("&", "&amp;", str_replace("&amp;", "&",$pageURL));
		}
 /* DV Code END */
            ]]></add>
        </operation>
	</file>
       	
	<file name="catalog/controller/product/category.php">
		<operation>
            <search position="after"  ><![CDATA[$this->load->model('catalog/category');]]></search>
            <add><![CDATA[ 
		$this->load->model('setting/setting');]]></add>
        </operation>	
        <operation>
            <search position="after" index="1"><![CDATA[$data['continue'] = $this->url->link('common/home');]]></search>
            <add><![CDATA[
/* DV Code START*/
			$this->document->addLink($this->url->link('product/category', 'path=' . $this->request->get['path']), 'canonical');
			if(isset($this->request->get['page']) && $this->request->get['page'] == 1){
				$this->response->redirect($this->url->link('product/category', 'path=' . $this->request->get['path'], 'SSL'), '301');
			}
			if(!isset($page)){ $page = 1; }
			if($page > 1){
				$page_prev = (int)$page - 1; 
			$this->document->addLink($this->url->link('product/category', 'path=' . $this->request->get['path'] . $url  .'&page=' . $page_prev), 'prev');
			}
			$total_page = round($product_total / $limit);
			if($page < $total_page ){
				$page_next = (int)$page + 1; 
			$this->document->addLink($this->url->link('product/category', 'path=' . $this->request->get['path'] . $url  .'&page='  . $page_next ), 'next');
			}
/* 	DV Code END  */
            ]]></add>
        </operation>				
    </file>	
	<file name="catalog/controller/product/search.php">
        <operation>
            <search position="after" index="1"><![CDATA[$pagination->url = $this->url->link('product/search', $url . '&page={page}');]]></search>
            <add><![CDATA[
/*  DV Code START  */
			$this->document->addLink($this->url->link('product/search'), 'canonical');
			if(isset($this->request->get['page']) && $this->request->get['page'] == 1){
				$this->response->redirect($this->url->link('product/search','', 'SSL'), '301');
			}
			if(!isset($page)){ $page = 1; }
			if($page > 1){
				$page_prev = (int)$page - 1; 
			$this->document->addLink($this->url->link('product/search', $url . '&page=' . $page_prev), 'prev');
			}
			$total_page = round($product_total / $limit);
			if($page < $total_page ){
				$page_next = (int)$page + 1; 
			$this->document->addLink($this->url->link('product/search', $url . '&page='  . $page_next ), 'next');
			}
/*   DV Code END  */
            ]]></add>
        </operation>				
    </file>	
	<file name="catalog/controller/product/manufacturer.php">
        <operation>
            <search position="after" index="1"><![CDATA[$pagination->url = $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id'] .  $url . '&page={page}');]]></search>
            <add><![CDATA[
/* DV Code START  */
			$this->document->addLink($this->url->link('product/manufacturer/info','manufacturer_id=' . $this->request->get['manufacturer_id']), 'canonical');
			if(isset($this->request->get['page']) && $this->request->get['page'] == 1){
				$this->response->redirect($this->url->link('product/manufacturer/info','manufacturer_id=' . $this->request->get['manufacturer_id'], 'SSL'), '301');
			}
			if(!isset($page)){ $page = 1; }
			if($page > 1){
				$page_prev = (int)$page - 1; 
			$this->document->addLink($this->url->link('product/manufacturer/info','manufacturer_id=' . $this->request->get['manufacturer_id'] .  $url . '&page=' . $page_prev), 'prev');
			}
			$total_page = round($product_total / $limit);
			if($page < $total_page ){
				$page_next = (int)$page + 1; 
			$this->document->addLink($this->url->link('product/manufacturer/info','manufacturer_id=' . $this->request->get['manufacturer_id'] .  $url . '&page='  . $page_next ), 'next');
			}
/*  DV Code END */
            ]]></add>
        </operation>				
    </file>
	<file name="catalog/controller/product/special.php">
        <operation>
            <search position="after" index="1"><![CDATA[$pagination->url = $this->url->link('product/special', $url . '&page={page}');]]></search>
            <add><![CDATA[
/*  DV Code START   */
			$this->document->addLink($this->url->link('product/special'), 'canonical');
			if(isset($this->request->get['page']) && $this->request->get['page'] == 1){
				$this->response->redirect($this->url->link('product/special', '', 'SSL'), '301');
			}
			if(!isset($page)){ $page = 1; }
			if($page > 1){
				$page_prev = (int)$page - 1; 
			$this->document->addLink($this->url->link('product/special', $url . '&page=' . $page_prev), 'prev');
			}
			$total_page = round($product_total / $limit);
			if($page < $total_page ){
				$page_next = (int)$page + 1; 
			$this->document->addLink($this->url->link('product/special', $url . '&page='  . $page_next ), 'next');
			}
/*  DV Code END */
            ]]></add>
        </operation>				
    </file>
	<!-- Product url -->
	<file name="catalog/controller/product/category.php">
        <operation>
            <search position="replace"><![CDATA['href'        => $this->url->link('product/product', 'path=' . $this->request->get['path'] . '&product_id=' . $result['product_id'] . $url)]]></search>
            <add><![CDATA[
								'href' => 	($this->model_setting_setting->getSettingValue('d_seo', 'd_seo_url_type',$this->config->get('config_store_id')) ) ? ($this->url->link('product/product', 'product_id=' . $result['product_id'])) : $this->url->link('product/product', 'path=' . $this->request->get['path'] . '&product_id=' . $result['product_id'] . $url)
												]]></add>
        </operation>				
    </file>
	<file name="catalog/controller/product/manufacturer.php">
        <operation>
            <search position="replace"><![CDATA['href'        => $this->url->link('product/product', 'manufacturer_id=' . $result['manufacturer_id'] . '&product_id=' . $result['product_id'] . $url)]]></search>
            <add><![CDATA[
								'href' =>	(($this->model_setting_setting->getSettingValue('d_seo', 'd_seo_url_type',$this->config->get('config_store_id')))  ) ? ($this->url->link('product/product', 'product_id=' . $result['product_id'])) : $this->url->link('product/product', 'manufacturer_id=' . $result['manufacturer_id'] . '&product_id=' . $result['product_id'] . $url)
												]]></add>
        </operation>
		<operation>
            <search position="after"  ><![CDATA[$this->load->language('product/manufacturer');]]></search>
            <add><![CDATA[ 
		$this->load->model('setting/setting');]]></add>
        </operation>			
    </file>
	<file name="catalog/controller/product/search.php">
        <operation>
            <search position="replace"><![CDATA['href'        => $this->url->link('product/product', 'product_id=' . $result['product_id'] . $url)]]></search>
            <add><![CDATA[
				'href' =>	(($this->model_setting_setting->getSettingValue('d_seo', 'd_seo_url_type',$this->config->get('config_store_id'))) ) ? ($this->url->link('product/product', 'product_id=' . $result['product_id'])) : $this->url->link('product/product', 'product_id=' . $result['product_id'] . $url)
												]]></add>
        </operation>				
		<operation>
            <search position="after"  ><![CDATA[$this->load->language('product/search');]]></search>
            <add><![CDATA[ 
		$this->load->model('setting/setting');]]></add>
        </operation>	
    </file>
	<file name="catalog/controller/product/special.php">
        <operation>
            <search position="replace"><![CDATA['href'        => $this->url->link('product/product', 'product_id=' . $result['product_id'] . $url)]]></search>
            <add><![CDATA[
												'href' =>	(($this->model_setting_setting->getSettingValue('d_seo', 'd_seo_url_type',$this->config->get('config_store_id')))  ) ? ($this->url->link('product/product', 'product_id=' . $result['product_id']))	: $this->url->link('product/product', 'product_id=' . $result['product_id'] . $url)
												]]></add>
        </operation>
		<operation>
            <search position="after"  ><![CDATA[$this->load->language('product/special');]]></search>
            <add><![CDATA[ 
		$this->load->model('setting/setting');]]></add>
        </operation>			
    </file>
	<file name="catalog/model/catalog/category.php">
        <operation>
            <search position="before"><![CDATA[public function getTotalCategoriesByCategoryId($parent_id = 0) {]]></search>
            <add><![CDATA[
												/*
            * DV Code START
            */	
	public function getPath($category_id) {
	if ($this->customer->isLogged()) {
			$customer_group_id = $this->customer->getGroupId();
		} else {
			$customer_group_id = $this->config->get('config_customer_group_id');
		}
		
		$cache = md5($category_id);
		
		$product_data = $this->cache->get('getPath.' . $category_id . $cache . '.' . $customer_group_id);
		
		if (!$product_data) {
		$query = $this->db->query("SELECT c.category_id, name, parent_id FROM " . DB_PREFIX . "category c LEFT JOIN " . DB_PREFIX . "category_description cd ON (c.category_id = cd.category_id) WHERE c.category_id = '" . (int)$category_id . "' AND cd.language_id = '" . (int)$this->config->get('config_language_id') . "' ORDER BY c.sort_order, cd.name ASC");
		
		if ($query->row['parent_id']) {
			$product_data = $this->getPath($query->row['parent_id'], $this->config->get('config_language_id')) .'_'. $query->row['category_id'];
		} else {
			$product_data = $query->row['category_id'];
		}
		$this->cache->set('getPath.' . $cache . '.' . $customer_group_id, $product_data);
		}
		return $product_data;
	}
			/*
            * DV Code END
            */
            ]]></add>
        </operation>				
    </file>
	<file name="catalog/controller/product/product.php">
        <operation>
            <search position="after"><![CDATA[$this->load->model('catalog/category');]]></search>
            <add><![CDATA[
/*  DV Code START  */
		$this->load->model('setting/setting');
		if($this->model_setting_setting->getSettingValue('d_seo', 'd_seo_url_type',$this->config->get('config_store_id'))) {
			if($this->url->link('product/product', 'product_id=' . $this->request->get['product_id']) != $this->url->currentUrl){$this->response->redirect($this->url->link('product/product', 'product_id=' . $this->request->get['product_id'], 'SSL'), '301');}
			
			if (isset($this->request->get['product_id'])) {
			$product_id = (int)$this->request->get['product_id'];
		} else {
			$product_id = 0;
		}
		$this->load->model('catalog/product');
		$categories = $this->model_catalog_product->getCategories($product_id);
		$path_id = end($categories);
		$path = $this->model_catalog_category->getPath($path_id['category_id']);
		$this->request->get['path'] = $path;
		}
/*  DV Code END */
            ]]></add>
        </operation>				
    </file>	
	<file name="catalog/controller/product/category.php">
        <operation>
            <search position="before"><![CDATA[$category_info = $this->model_catalog_category->getCategory($category_id);]]></search>
            <add><![CDATA[
/* DV Code START  */
			
		$path = $this->model_catalog_category->getPath($category_id);
		if($path){
			$this->request->get['path'] = $path;
		}
		
		$url = '';
		if(isset($this->request->get['sort'])){
			$url = $url.'&sort='.$this->request->get['sort'];
		}
		if(isset($this->request->get['limit'])){
			$url = $url.'&limit='.$this->request->get['limit'];
		}
		if(isset($this->request->get['order'])){
			$url = $url.'&order='.$this->request->get['order'];
		}
		if(isset($this->request->get['page'])){
			$url = $url.'&page='.$this->request->get['page'];
		}
		if(isset($this->request->get['filter'])){
			$url = $url.'&filter='.$this->request->get['filter'];
		} 

		if($this->url->link('product/category', 'path=' . $this->request->get['path'].$url) != $this->url->currentUrl){
			$this->response->redirect($this->url->link('product/category', 'path=' . $this->request->get['path'].$url, 'SSL'), '301');
		}
/*  DV Code END */
            ]]></add>
        </operation>				
    </file>	
    <file name="catalog/controller/common/footer.php">
		<operation error="skip">
			<search position="before"><![CDATA[$this->load->model('catalog/information');]]></search>
			<add><![CDATA[$data['text_itemscope'] = $this->language->get('text_itemscope');
        $data['text_itemscope_link'] = $this->language->get('text_itemscope_link');
        $data['text_itemscope_adress'] = $this->language->get('text_itemscope_adress');]]></add>
		</operation>
	</file>

</modification>
